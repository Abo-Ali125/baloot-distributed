<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baloot - Traditional Saudi Card Game</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background:linear-gradient(135deg,#0f172a 0%, #1e293b 100%); color:#e2e8f0; min-height:100vh; overflow-x:hidden; }
    .auth-container { min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:20px; background: linear-gradient(135deg,#1e3a8a 0%, #7c3aed 100%); }
    .auth-card { background: rgba(15,23,42,.95); border-radius:20px; padding:40px; width:100%; max-width:450px; backdrop-filter:blur(20px); border:1px solid rgba(148,163,184,.1); box-shadow:0 25px 50px -12px rgba(0,0,0,.5); }
    .auth-header { text-align:center; margin-bottom:30px; }
    
    .auth-header h1 { font-size:3rem; background:linear-gradient(135deg,#3b82f6,#a78bfa); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:10px; }
    .auth-header p { color:#94a3b8; font-size:1.1rem; }
    .auth-form { display:flex; flex-direction:column; gap:20px; }
    .form-group { display:flex; flex-direction:column; gap:8px; }
  
    .form-group label { color:#cbd5e1; font-weight:500; font-size:.95rem; }
    .form-group input { padding:12px 16px; border:1px solid rgba(148,163,184,.2); border-radius:10px; background:rgba(30,41,59,.8); color:#e2e8f0; font-size:1rem; transition:all .3s ease; }
    .form-group input:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .btn { padding:12px 24px; border:none; border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer; transition:all .3s ease; text-transform:uppercase; letter-spacing:.5px; }
    .btn-primary { background:linear-gradient(135deg,#3b82f6,#8b5cf6); color:white; box-shadow:0 4px 15px rgba(59,130,246,.3); }
    .btn-primary:hover:not(:disabled){ transform:translateY(-2px); box-shadow:0 8px 25px rgba(59,130,246,.4); }
    .btn-secondary { background:transparent; color:#3b82f6; border:1px solid rgba(59,130,246,.5); }
    .btn-secondary:hover { background:rgba(59,130,246,.1); }
    .auth-switch { text-align:center; margin-top:20px; color:#94a3b8; }
    .auth-switch a { color:#3b82f6; text-decoration:none; font-weight:600; cursor:pointer; }
    .auth-switch a:hover { text-decoration:underline; }
    .game-app { display:none; }
    .game-app.active { display:block; }
    .container { max-width:1400px; margin:0 auto; padding:20px; min-height:100vh; }
    .navbar { background: rgba(15,23,42,.95); border-radius:15px; padding:15px 25px; margin-bottom:20px; backdrop-filter: blur(10px); border:1px solid rgba(148,163,184,.1); display:flex; justify-content:space-between; align-items:center; }
    .nav-brand h2{ font-size:1.8rem; background:linear-gradient(135deg,#3b82f6,#8b5cf6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .nav-user { display:flex; align-items:center; gap:20px; }
    .user-info{ display:flex; align-items:center; gap:10px; }
    .user-avatar{ width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,#3b82f6,#8b5cf6); display:flex; align-items:center; justify-content:center; font-weight:bold; color:white; }
    .user-details{ display:flex; flex-direction:column; }
    .user-name{ font-weight:600; color:#e2e8f0; }
    .user-level{ font-size:.85rem; color:#94a3b8; }
    .main-content{ display:grid; grid-template-columns:300px 1fr 300px; gap:20px; margin-top:20px; }
    .panel{ background:rgba(15,23,42,.95); border:1px solid rgba(148,163,184,.2); border-radius:15px; padding:20px; backdrop-filter:blur(10px); }
    .panel h3{ color:#3b82f6; margin-bottom:15px; font-size:1.2rem; display:flex; align-items:center; gap:10px; }
    .room-browser{ max-height:400px; overflow-y:auto; }
    .room-item{ padding:12px; margin-bottom:10px; background:rgba(30,41,59,.6); border-radius:10px; border:1px solid rgba(148,163,184,.2); cursor:pointer; transition:all .3s ease; }
    .room-item:hover{ background:rgba(59,130,246,.1); border-color:rgba(59,130,246,.3); }
    .room-name{ font-weight:600; margin-bottom:5px; }
    .room-info{ display:flex; justify-content:space-between; font-size:.9rem; color:#94a3b8; }
    .friends-list{ max-height:400px; overflow-y:auto; }
    .friend-item{ display:flex; align-items:center; gap:12px; padding:10px; margin-bottom:8px; background:rgba(30,41,59,.6); border-radius:10px; cursor:pointer; transition:all .3s ease; }
    .friend-item:hover{ background:rgba(59,130,246,.1); }
    .friend-avatar{ width:35px; height:35px; border-radius:50%; background:#475569; display:flex; align-items:center; justify-content:center; font-weight:600; }
    .friend-info{ flex:1; }
    .friend-name{ font-weight:500; margin-bottom:2px; }
    .friend-status{ font-size:.85rem; color:#94a3b8; }
    .online-indicator{ width:8px; height:8px; border-radius:50%; background:#10b981; }
    .offline-indicator{ width:8px; height:8px; border-radius:50%; background:#6b7280; }
    .game-table{ background:radial-gradient(ellipse at center, rgba(16,185,129,.1) 0%, rgba(15,23,42,.95) 70%); border:2px solid rgba(16,185,129,.3); border-radius:20px; padding:40px; min-height:500px; position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .player-positions{ position:relative; width:100%; height:400px; }
    .player-slot{ position:absolute; width:120px; padding:15px; background:rgba(30,41,59,.8); border:2px solid rgba(148,163,184,.3); border-radius:12px; text-align:center; transition:all .3s ease; }
    .player-slot.active{ background:rgba(59,130,246,.2); border-color:rgba(59,130,246,.5); box-shadow:0 0 20px rgba(59,130,246,.3); }
    .player-slot.top{ top:0; left:50%; transform:translateX(-50%); }
    .player-slot.right{ right:0; top:50%; transform:translateY(-50%); }
    .player-slot.bottom{ bottom:0; left:50%; transform:translateX(-50%); }
    .player-slot.left{ left:0; top:50%; transform:translateY(-50%); }
    .trick-area{ position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); display:grid; grid-template-columns:repeat(2, 100px); gap:15px; }
    .trick-card-slot{ width:100px; height:140px; background:rgba(30,41,59,.5); border:2px dashed rgba(148,163,184,.3); border-radius:10px; display:flex; align-items:center; justify-content:center; transition:all .3s ease; }
    .trick-card-slot.filled{ background:linear-gradient(135deg,#f8fafc,#e2e8f0); border:2px solid #cbd5e1; color:#1e293b; font-size:1.8rem; font-weight:bold; }
    .hand-area{ background:rgba(15,23,42,.95); border-radius:15px; padding:20px; margin-top:20px; }
    .hand{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; padding:20px; min-height:120px; }
    .card{ background:linear-gradient(135deg,#f8fafc,#e2e8f0); color:#1e293b; border:2px solid #cbd5e1; border-radius:10px; padding:15px 20px; font-size:1.3rem; font-weight:bold; cursor:pointer; transition:all .3s ease; user-select:none; min-width:70px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .card:hover{ transform:translateY(-10px) scale(1.05); box-shadow:0 15px 30px rgba(0,0,0,.3); border-color:#3b82f6; }
    .card.hearts,.card.diamonds{ color:#dc2626; }
    .card.clubs,.card.spades{ color:#1f2937; }
    .score-board{ display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px; }
    .team-score{ text-align:center; padding:20px; background:rgba(30,41,59,.8); border-radius:12px; border:1px solid rgba(148,163,184,.3); }
    .team-score.winning{ background:rgba(16,185,129,.2); border-color:rgba(16,185,129,.5); box-shadow:0 0 20px rgba(16,185,129,.2); }
    .team-name{ font-size:1.1rem; font-weight:600; margin-bottom:10px; color:#94a3b8; }
    .team-points{ font-size:2.5rem; font-weight:bold; color:#3b82f6; }
    .chat-box{ height:300px; display:flex; flex-direction:column; }
    .chat-messages{ flex:1; overflow-y:auto; padding:10px; background:rgba(7,16,34,.5); border-radius:10px; margin-bottom:10px; }
    .chat-message{ margin-bottom:10px; padding:8px; background:rgba(30,41,59,.6); border-radius:8px; }
    .chat-author{ font-weight:600; color:#3b82f6; margin-bottom:3px; }
    .chat-text{ color:#e2e8f0; font-size:.95rem; }
    .chat-input-group{ display:flex; gap:10px; }
    .chat-input{ flex:1; padding:10px; border:1px solid rgba(148,163,184,.3); border-radius:8px; background:rgba(30,41,59,.8); color:#e2e8f0; }
    .notification{ position:fixed; top:20px; right:20px; padding:15px 20px; background:rgba(15,23,42,.95); border-radius:10px; border:1px solid rgba(148,163,184,.3); backdrop-filter:blur(10px); z-index:1000; animation:slideIn .3s ease; max-width:350px; }
    @keyframes slideIn { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
    .notification.success{ border-color:rgba(16,185,129,.5); background:rgba(16,185,129,.1); }
    .notification.error{ border-color:rgba(239,68,68,.5); background:rgba(239,68,68,.1); }
    .notification.info{ border-color:rgba(59,130,246,.5); background:rgba(59,130,246,.1); }
    .loading-spinner{ width:50px; height:50px; border:3px solid rgba(59,130,246,.3); border-radius:50%; border-top-color:#3b82f6; animation:spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @media (max-width:1200px){ .main-content{ grid-template-columns:1fr; } .sidebar{ display:none; } }
    @media (max-width:768px){ .auth-card{ padding:30px 20px; } .container{ padding:10px; } .game-table{ padding:20px; } .card{ padding:10px 15px; font-size:1.1rem; } }
  </style>
</head>
  
<body>
  <div id="authScreen" class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <h1>🎯 Baloot</h1>
        <p>Traditional Saudi Card Game</p>
      </div>
      <form id="loginForm" class="auth-form">
        <div class="form-group">
          <label for="loginUsername">Username or Email</label>
          <input type="text" id="loginUsername" required placeholder="Enter your username or email" />
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" required placeholder="Enter your password" />
        </div>
        <button type="submit" class="btn btn-primary">Login</button>
        <div class="auth-switch">Don't have an account? <a id="switchToRegister">Register</a></div>
      </form>
      <form id="registerForm" class="auth-form" style="display: none;">
        <div class="form-group">
          <label for="regUsername">Username</label>
          <input type="text" id="regUsername" required placeholder="Choose a username" />
        </div>
        <div class="form-group">
          <label for="regEmail">Email</label>
          <input type="email" id="regEmail" required placeholder="Enter your email" />
        </div>
        <div class="form-group">
          <label for="regPassword">Password</label>
          <input type="password" id="regPassword" required placeholder="Create a password (min 6 characters)" />
        </div>
        <div class="form-group">
          <label for="regConfirmPassword">Confirm Password</label>
          <input type="password" id="regConfirmPassword" required placeholder="Confirm your password" />
        </div>
        <button type="submit" class="btn btn-primary">Register</button>
        <div class="auth-switch">Already have an account? <a id="switchToLogin">Login</a></div>
      </form>
    </div>
  </div>

  <div id="gameApp" class="game-app">
    <div class="container">
      <nav class="navbar">
      <div class="nav-brand"><h2>🎯 Baloot</h2></div>
    <div class="nav-user">
      <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <div class="user-name" id="userName">Username</div>
        <div class="user-level" id="userLevel">Level 1 • 0 XP</div>
          </div>
        </div>
      <button class="btn btn-secondary" id="logoutBtn">Logout</button>
        </div>
      </nav>

      <div class="main-content">
        <aside class="sidebar">
          <div class="panel">
            <h3>🎮 Active Rooms</h3>
            <div class="form-group">
              <input type="text" id="roomNameInput" placeholder="Room name..." />
              <button class="btn btn-primary" id="createRoomBtn" style="width:100%; margin-top:10px;">Create Room</button>
            </div>
            <div class="room-browser" id="roomBrowser"></div>
          </div>

          <div class="panel" style="margin-top:20px;">
            <h3>👥 Friends</h3>
            <div class="form-group">
              <input type="text" id="friendUsername" placeholder="Add friend by username..." />
              <button class="btn btn-secondary" id="addFriendBtn" style="width:100%; margin-top:10px;">Add Friend</button>
            </div>
            <div class="friends-list" id="friendsList"></div>
          </div>
        </aside>
        // Store session info in localStorage for reconnection
function saveSessionInfo(sessionId, roomId, seat) {
  localStorage.setItem('gameSession', JSON.stringify({
    sessionId,
    roomId,
    seat,
    timestamp: Date.now()
  }));
}

// Check for existing session on load
async function checkForReconnection() {
  const saved = localStorage.getItem('gameSession');
  if (!saved) return false;
  
  try {
    const { sessionId, roomId, seat, timestamp } = JSON.parse(saved);
    // Only try to reconnect if session is less than 30 minutes old
    if (Date.now() - timestamp > 30 * 60 * 1000) {
      localStorage.removeItem('gameSession');
      return false;
    }
    
    const shouldReconnect = confirm(`You have an active game in room "${roomId}". Reconnect?`);
    if (!shouldReconnect) {
      localStorage.removeItem('gameSession');
      return false;
    }
    
    // Attempt reconnection
    const data = await api.json('/api/reconnect', {
      method: 'POST',
      headers: { 'Authorization': authToken },
      body: JSON.stringify({ session_id: sessionId, room_id: roomId })
    });
    
    // Restore state
    sessionId = data.session_id;
    currentRoomId = data.room_state.room_id;
    playerSeat = data.seat;
    lastTimestamp = 0;
    
    document.getElementById('currentRoom').textContent = currentRoomId;
    document.getElementById('yourSeat').textContent = playerSeat + 1;
    document.getElementById('yourTeam').textContent = [0,2].includes(playerSeat) ? 'A' : 'B';
    
    updatePlayers(data.players);
    if (data.hand) renderHand(data.hand);
    if (data.team_scores) updateScores(data.team_scores);
    if (data.current_trick) updateTrickArea(data);
    
    saveSessionInfo(sessionId, currentRoomId, playerSeat);
    startPolling();
    
    showNotification('Reconnected successfully!', 'success');
    return true;
    
  } catch (e) {
    console.error('Reconnection failed:', e);
    localStorage.removeItem('gameSession');
    showNotification('Could not reconnect to game', 'error');
    return false;
  }
}

        <main>
          <div class="panel">
            <h3>🎮 Game Table</h3>
            <div class="game-table">
              <div class="player-positions">
                <div class="player-slot top" id="player0"><div class="player-name">Waiting...</div></div>
                <div class="player-slot right" id="player1"><div class="player-name">Waiting...</div></div>
                <div class="player-slot bottom" id="player2"><div class="player-name">Waiting...</div></div>
                <div class="player-slot left" id="player3"><div class="player-name">Waiting...</div></div>
                <div class="trick-area" id="trickArea">
                  <div class="trick-card-slot" id="trickCard0"></div>
                  <div class="trick-card-slot" id="trickCard1"></div>
                  <div class="trick-card-slot" id="trickCard2"></div>
                  <div class="trick-card-slot" id="trickCard3"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="score-board">
            <div class="team-score" id="teamAScore">
              <div class="team-name">Team A (Seats 1 & 3)</div>
              <div class="team-points">0</div>
            </div>
            <div class="team-score" id="teamBScore">
              <div class="team-name">Team B (Seats 2 & 4)</div>
              <div class="team-points">0</div>
            </div>
          </div>

          <div class="hand-area">
            <h3>🎴 Your Hand</h3>
            <div class="hand" id="playerHand"></div>
          </div>
        </main>

        <aside class="sidebar">
          <div class="panel">
            <h3>📊 Game Info</h3>
            <div style="padding:10px;">
              <p><strong>Room:</strong> <span id="currentRoom">-</span></p>
              <p><strong>Your Seat:</strong> <span id="yourSeat">-</span></p>
              <p><strong>Your Team:</strong> <span id="yourTeam">-</span></p>
              <p><strong>Current Turn:</strong> <span id="currentTurn">-</span></p>
              <p><strong>Trick #:</strong> <span id="trickNumber">-</span></p>
              <p><strong>Round:</strong> <span id="roundNumber">-</span></p>
            </div>
            <button class="btn btn-primary" id="readyBtn" style="width:100%; margin-top:10px;">Ready to Play</button>
          </div>

          <div class="panel" style="margin-top:20px;">
            <h3>💬 Chat</h3>
            <div class="chat-box">
              <div class="chat-messages" id="chatMessages"></div>
              <div class="chat-input-group">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." />
                <button class="btn btn-secondary" id="sendChatBtn">Send</button>
              </div>
            </div>
          </div>

          <div class="panel" style="margin-top:20px;">
            <h3>🏆 Top Players</h3>
            <div id="leaderboard" style="max-height:200px; overflow-y:auto;"></div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    const api = {
      async json(url, opts = {}) {
        const res = await fetch(url, {
          ...opts,
          headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) }
        });
        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const text = await res.text();
          throw new Error(`Expected JSON, got: ${text.slice(0,120)}`);
        }
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Request failed');
        return data;
      },
    };

    function showNotification(message, type = 'info') {
      const n = document.createElement('div');
      n.className = `notification ${type}`;
      n.textContent = message;
      document.body.appendChild(n);
      setTimeout(() => { n.style.animation = 'slideIn .3s ease reverse'; setTimeout(() => n.remove(), 300); }, 3000);
    }

    function formatCard(card){ const s = card.slice(-1), r = card.slice(0,-1); const m={H:'♥️',D:'♦️',C:'♣️',S:'♠️'}; return r + m[s]; }
    function getCardClass(card){ const s = card.slice(-1); return s==='H'||s==='D' ? 'hearts' : (s==='S'?'spades':'clubs'); }

    let authToken = localStorage.getItem('authToken');
    let currentUser = null;
    let sessionId = null;
    let currentRoomId = null;
    let playerSeat = null;
    let lastTimestamp = 0;
    let polling = false;

    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const switchToRegister = document.getElementById('switchToRegister');
    const switchToLogin = document.getElementById('switchToLogin');
    const logoutBtn = document.getElementById('logoutBtn');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const addFriendBtn = document.getElementById('addFriendBtn');
    const readyBtn = document.getElementById('readyBtn');
    const sendChatBtn = document.getElementById('sendChatBtn');

    switchToRegister.onclick = () => { loginForm.style.display='none'; registerForm.style.display='block'; };
    switchToLogin.onclick = () => { registerForm.style.display='none'; loginForm.style.display='block'; };

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      try {
        const data = await api.json('/api/login', { method:'POST', body: JSON.stringify({ username, password }) });
        authToken = data.auth_token; currentUser = data.user; localStorage.setItem('authToken', authToken);
        await showGameApp();
      } catch (err) { showNotification(err.message || 'Login failed', 'error'); }
    });

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('regUsername').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;
      if (password !== confirmPassword) { showNotification('Passwords do not match','error'); return; }
      try {
        const data = await api.json('/api/register', { method:'POST', body: JSON.stringify({ username, email, password }) });
        authToken = data.auth_token; currentUser = data.user; localStorage.setItem('authToken', authToken);
        await showGameApp();
      } catch (err) { showNotification(err.message || 'Registration failed', 'error'); }
    });

    logoutBtn.onclick = async () => {
      try { await fetch('/api/logout', { method:'POST', headers:{ 'Authorization': authToken } }); } catch {}
      localStorage.removeItem('authToken'); location.reload();
    };

    createRoomBtn.onclick = async () => {
      const roomName = document.getElementById('roomNameInput').value || `Room-${Date.now()}`;
      await joinRoom(roomName);
    };

    addFriendBtn.onclick = async () => {
      const username = document.getElementById('friendUsername').value.trim();
      if (!username) return;
      try {
        await api.json('/api/friends/add', { method:'POST', headers:{ 'Authorization': authToken }, body: JSON.stringify({ username }) });
        showNotification('Friend request sent', 'success');
        document.getElementById('friendUsername').value = '';
        loadFriends();
      } catch (err) { showNotification(err.message || 'Failed to add friend','error'); }
    };

    readyBtn.onclick = async () => {
      if (!sessionId) return showNotification('Join a room first', 'error');
      try { 
        await api.json('/api/ready', { method:'POST', body: JSON.stringify({ session_id: sessionId }), headers:{ 'Authorization': authToken } }); 
        readyBtn.disabled = true; 
        showNotification('Ready to play!','success'); 
      } catch (e){ showNotification(e.message,'error'); }
    };

    sendChatBtn.onclick = sendChat;
    document.getElementById('chatInput').addEventListener('keypress', e => { if (e.key==='Enter') sendChat(); });

    async function loadProfile() {
      try {
        const res = await fetch('/api/profile', { headers:{ 'Authorization': authToken } });
        if (res.ok) { currentUser = await res.json(); return true; }
      } catch {}
      return false;
    }

    async function loadRooms() {
      try {
        const rooms = await api.json('/api/rooms');
        const rb = document.getElementById('roomBrowser'); rb.innerHTML = '';
        rooms.forEach(r => {
          const el = document.createElement('div'); el.className = 'room-item';
          el.innerHTML = `<div class="room-name">${r.room_id}</div><div class="room-info"><span>${r.player_count}/4 players</span><span>${r.game_state}</span></div>`;
          el.onclick = () => joinRoom(r.room_id);
          rb.appendChild(el);
        });
      } catch (e) { console.error('loadRooms', e); }
    }

    async function loadFriends() {
      try {
        const friends = await api.json('/api/friends', { headers:{ 'Authorization': authToken } });
        const list = document.getElementById('friendsList'); list.innerHTML = '';
        friends.forEach(f => {
          const el = document.createElement('div'); el.className = 'friend-item';
          el.innerHTML = `<div class="friend-avatar">${(f.display_name||f.username)[0]}</div><div class="friend-info"><div class="friend-name">${f.display_name||f.username}</div><div class="friend-status">Level ${f.level}</div></div><div class="${f.online?'online-indicator':'offline-indicator'}"></div>`
          list.appendChild(el);
        });
      } catch (e) { console.error('loadFriends', e); }
    }

    async function loadLeaderboard() {
      try {
        const players = await api.json('/api/leaderboard');
        const lb = document.getElementById('leaderboard');
        lb.innerHTML = players.map(p => `<div style="padding:8px; border-bottom:1px solid rgba(148,163,184,.1);"><strong>#${p.rank}</strong> ${p.display_name} <span style="color:#94a3b8;">Lvl ${p.level} • ${Number(p.win_rate||0).toFixed(1)}% WR</span></div>`).join('');
      } catch (e) { console.error('loadLeaderboard', e); }
    }

    async function joinRoom(roomId){
      try {
        const data = await api.json('/api/join', { method:'POST', headers:{ 'Authorization': authToken }, body: JSON.stringify({ room_id: roomId })});
        sessionId = data.session_id; currentRoomId = roomId; playerSeat = data.seat; lastTimestamp = 0;
        document.getElementById('currentRoom').textContent = roomId;
        document.getElementById('yourSeat').textContent = playerSeat + 1;
        document.getElementById('yourTeam').textContent = [0,2].includes(playerSeat) ? 'A' : 'B';
        updatePlayers(data.players);
        startPolling();
        showNotification(`Joined room: ${roomId}`, 'success');
      } catch (e){ showNotification(e.message || 'Failed to join room','error'); }
    }

    function updatePlayers(players){
      for(let seat=0; seat<4; seat++){
        const el = document.getElementById(`player${seat}`);
        if(players[seat]){
          
          el.innerHTML = `<div class="player-name">${players[seat].name}</div><div style="font-size:.9rem; color:#94a3b8;">Team ${players[seat].team} ${players[seat].is_ready ? '✓':''}</div>`;
          if (seat === playerSeat) el.classList.add('active'); else el.classList.remove('active');
          
        } else { el.innerHTML = '<div class="player-name">Waiting...</div>'; el.classList.remove('active'); }
      }
    }

    function renderHand(cards){
      const handEl = document.getElementById('playerHand'); handEl.innerHTML = '';
      cards.forEach(card => { const el = document.createElement('div'); el.className = `card ${getCardClass(card)}`; el.textContent = formatCard(card); el.onclick = () => playCard(card); handEl.appendChild(el); });
    }

    async function playCard(card){
      if(!sessionId) return;
      if(!confirm(`Play ${formatCard(card)}?`)) return;
      try{
        
        await api.json('/api/play_card', { method:'POST', body: JSON.stringify({ session_id: sessionId, card }) });
      } catch(e){ showNotification(e.message || 'Cannot play card','error'); }
    }

    function updateTrickArea(data){
      if(data.current_trick){
        data.current_trick.forEach(tr => { const slot = document.getElementById(`trickCard${tr.seat}`); slot.className = 'trick-card-slot filled'; slot.textContent = formatCard(tr.card); });
      }
      const turnEl = document.getElementById('currentTurn');
      turnEl.textContent = data.next_player_name || (typeof data.next_player === 'number' ? `Player ${data.next_player+1}` : '-');
    }

    function clearTrickArea(){
      for(let i=0;i<4;i++){ const slot = document.getElementById(`trickCard${i}`); slot.className='trick-card-slot'; slot.textContent=''; }
    }

    function updateScores(scores){
      const a = document.querySelector('#teamAScore .team-points');
      const b = document.querySelector('#teamBScore .team-points');
      a.textContent = scores.team_a || 0; b.textContent = scores.team_b || 0;
      document.getElementById('teamAScore').classList.toggle('winning',(scores.team_a||0)>(scores.team_b||0));
      
      document.getElementById('teamBScore').classList.toggle('winning',(scores.team_b||0)>(scores.team_a||0));
    }

    function addChatMessage(author, text){
      const box = document.getElementById('chatMessages');
      const m = document.createElement('div'); m.className = 'chat-message';
      m.innerHTML = `<div class="chat-author">${author}</div><div class="chat-text">${text}</div>`;
      box.appendChild(m); box.scrollTop = box.scrollHeight;
      while(box.children.length > 50) box.removeChild(box.firstChild);
    }

    async function sendChat(){
      const input = document.getElementById('chatInput');
      const msg = input.value.trim(); 
      if(!msg || !sessionId) return;
      
      try {
        await api.json('/api/chat', { 
          method:'POST', 
          headers:{ 'Authorization': authToken },
          body: JSON.stringify({ session_id: sessionId, message: msg }) 
        });
        input.value = '';
      } catch(e) {
        console.error('Chat error:', e);
        showNotification('Failed to send message', 'error');
      }
    }

    async function startPolling(){
      if (polling) return; polling = true;
      while(polling && sessionId){
        try{
          const url = `/api/poll?session_id=${encodeURIComponent(sessionId)}&last_timestamp=${encodeURIComponent(String(lastTimestamp||0))}`;
          const res = await fetch(url, { headers:{ 'Authorization': authToken } });
          const ct = res.headers.get('content-type')||'';
          
          if(!ct.includes('application/json')){ await new Promise(r=>setTimeout(r,1000)); continue; }
          const data = await res.json();
          if (data.events && data.events.length){
            data.events.forEach(ev => handleGameEvent(ev));
            lastTimestamp = data.last_timestamp || data.latest || lastTimestamp;
          }
          await new Promise(r=>setTimeout(r,1000));
        } catch(err){ console.error('polling', err); await new Promise(r=>setTimeout(r,1500)); }
      }
    }

    function handleGameEvent(event){
      switch(event.type){
        case 'player_joined': 
          updatePlayers(event.data.players); 
          addChatMessage('System', `${event.data.player_name} joined`); 
          break;
          
        case 'player_ready': 
          addChatMessage('System', `${event.data.player_name} is ready`); 
          if(event.data.players) updatePlayers(event.data.players);
          break;
          
        case 'game_started': 
          showNotification('Game started!','success'); 
          addChatMessage('System','Game started! Cards dealt...'); 
          readyBtn.disabled = true; 
          document.getElementById('roundNumber').textContent = event.data.round_number;
          clearTrickArea();
          document.getElementById('trickNumber').textContent = '1';
          break;
          
        case 'cards_dealt': 
          if (event.data.seat === playerSeat) {
            renderHand(event.data.cards);
          }
          break;
          
        case 'card_played': 
          updateTrickArea(event.data); 
          addChatMessage('Game', `${event.data.player_name} played ${formatCard(event.data.card)}`); 
          break;
          
        case 'trick_won': 
          showNotification(`${event.data.winner_name} wins the trick! (+${event.data.points} points)`, 'info'); 
          updateScores(event.data.team_scores); 
          addChatMessage('Game', `${event.data.winner_name} won trick ${event.data.trick_count} (+${event.data.points} pts)`);
          setTimeout(clearTrickArea, 1500); 
          break;
          
        case 'round_complete': 
          showNotification(`Round ${event.data.round_number} over! ${event.data.round_winner} wins!`, 'success'); 
          updateScores(event.data.total_scores); 
          addChatMessage('System', `🏆 ${event.data.round_winner} won round ${event.data.round_number} with ${event.data.winning_score} points!`);
          addChatMessage('System', `Total Scores - Team A: ${event.data.total_scores.team_a}, Team B: ${event.data.total_scores.team_b}`);
          
          document.getElementById('playerHand').innerHTML = '';
          clearTrickArea();
          readyBtn.disabled = false; 
          break;
          
        case 'game_complete': 
          showNotification(`🏆 Game Over! ${event.data.game_winner} wins the game!`, 'success'); 
          updateScores(event.data.final_total_scores); 
          addChatMessage('System', `🎉🎉🎉 ${event.data.game_winner} won the game! 🎉🎉🎉`);
          addChatMessage('System', `Final Scores - Team A: ${event.data.final_total_scores.team_a}, Team B: ${event.data.final_total_scores.team_b}`);
          document.getElementById('playerHand').innerHTML = '';
          clearTrickArea();
          break;
          
        case 'next_trick_ready': 
          document.getElementById('trickNumber').textContent = event.data.trick_number; 
          addChatMessage('Game', `Trick ${event.data.trick_number} - ${event.data.leader_name} leads`);
          break;
          
        case 'new_round_ready': 
          addChatMessage('System', event.data.message); 
          readyBtn.disabled = false; 
          break;
          
        case 'chat_message': 
          addChatMessage(event.data.author, event.data.message); 
          break;
      }
    }

    async function showGameApp(){
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('gameApp').classList.add('active');
      document.getElementById('userName').textContent = currentUser.display_name || currentUser.username;
      document.getElementById('userAvatar').textContent = (currentUser.username||'U')[0].toUpperCase();
      document.getElementById('userLevel').textContent = `Level ${currentUser.level||1} • ${currentUser.experience||0} XP`;
      loadRooms(); loadFriends(); loadLeaderboard();
    }

    async function init(){
      if (authToken) {
        const ok = await loadProfile();
        if (ok) await showGameApp();
      }
      setInterval(() => { if (currentUser && !currentRoomId) loadRooms(); }, 10000);
    }

    init();
  </script>
</body>
</html>
