<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Baloot - Demo UI</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0f1724; color:#e6eef8; margin:0; padding:20px; }
    .container { max-width:1000px; margin:0 auto; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    h1 { font-size:20px; margin:0; }
    .panel { background:#0b1220; border:1px solid #1f2937; padding:12px; border-radius:8px; margin-bottom:12px; }
    .row { display:flex; gap:12px; align-items:center; }
    .hand { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .card { background:#0b2540; border:1px solid #254a6b; padding:8px 12px; border-radius:6px; cursor:pointer; user-select:none; }
    .card:hover { transform:translateY(-3px); box-shadow:0 6px 18px rgba(0,0,0,0.6); }
    .events { max-height:320px; overflow:auto; background:#071022; padding:8px; border-radius:6px; border:1px solid #123043; }
    button { background:#2563eb; color:white; border:0; padding:8px 12px; border-radius:6px; cursor:pointer; }
    button.secondary { background:#334155; }
    input, select { padding:6px 8px; border-radius:6px; border:1px solid #253244; background:#071027; color:#e6eef8; }
    .small { font-size:13px; color:#9fb4d6; }
    .status { color:#7ee787; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Baloot — Demo UI</h1>
      <div class="small">Demo: uses long-polling /api/poll — good for quick demo</div>
    </header>

    <div class="panel">
      <div class="row">
        <label>Room id: <input id="roomId" value="demo-room" /></label>
        <label>Name: <input id="playerName" value="Player" /></label>
        <button id="btnJoin">Join Room</button>
        <button id="btnReady" class="secondary" disabled>Ready</button>
        <div style="margin-left:auto"><span id="status" class="small">Not joined</span></div>
      </div>
    </div>

    <div class="panel" id="roomPanel" style="display:none">
      <div class="row">
        <div>
          <div class="small">Session: <span id="sessionId"></span></div>
          <div class="small">Seat: <span id="seat"></span></div>
          <div class="small">Room state: <span id="roomState"></span></div>
        </div>
        <div style="margin-left:auto">
          <button id="btnGetState" class="secondary">Refresh Room State</button>
        </div>
      </div>

      <div style="margin-top:10px;">
        <strong>Your hand</strong>
        <div id="hand" class="hand"></div>
        <div class="small" style="margin-top:6px">Click a card to play (will POST /api/play_card).</div>
      </div>
    </div>

    <div class="panel">
      <strong>Events</strong>
      <div id="events" class="events"></div>
    </div>

    <div style="margin-top:12px; text-align:center" class="small">
      Tip: open multiple browser windows, join same room with different names to demo multiplayer.
    </div>
  </div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  let sessionId = null;
  let seat = null;
  let roomId = null;
  let polling = false;
  let lastTimestamp = 0;

  function logEvent(obj) {
    const el = document.createElement('div');
    el.innerText = (new Date()).toLocaleTimeString() + ' — ' + JSON.stringify(obj);
    document.getElementById('events').prepend(el);
  }

  async function api(path, method='GET', body=null) {
    const opts = { method, headers: {} };
    if (body) {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(body);
    }
    const res = await fetch(path, opts);
    const txt = await res.text();
    try {
      return { ok: res.ok, status: res.status, json: JSON.parse(txt) };
    } catch (e) {
      return { ok: res.ok, status: res.status, json: txt };
    }
  }

  async function startPolling() {
    if (polling) return;
    polling = true;
    logEvent({ msg: 'Started long-polling' });
    while (polling) {
      try {
        const url = new URL('/api/poll', window.location.origin);
        url.searchParams.set('session_id', sessionId);
        url.searchParams.set('last_timestamp', lastTimestamp || 0);
        const resp = await fetch(url, { method: 'GET' });
        if (!resp.ok) {
          const txt = await resp.text();
          logEvent({ error: 'poll error', status: resp.status, body: txt });
          await new Promise(r => setTimeout(r, 2000));
          continue;
        }
        const data = await resp.json();
        if (data.events && data.events.length) {
          for (const ev of data.events) {
            logEvent(ev);
          }
          lastTimestamp = data.last_timestamp || (data.events[data.events.length-1].timestamp);
        }
        // keep looping; server returns empty events on timeout
      } catch (e) {
        logEvent({ error: 'Polling connection failed', detail: e.toString() });
        await new Promise(r => setTimeout(r, 1500));
      }
    }
  }

  async function stopPolling() {
    polling = false;
  }

  async function joinRoom() {
    roomId = $('roomId').value || 'demo-room';
    const name = $('playerName').value || 'Player';
    const res = await api('/api/join', 'POST', { room_id: roomId, player_name: name });
    if (!res.ok) {
      logEvent({ error: 'join failed', status: res.status, body: res.json });
      alert('Join failed: ' + JSON.stringify(res.json));
      return;
    }
    sessionId = res.json.session_id;
    seat = res.json.seat;
    $('sessionId').innerText = sessionId;
    $('seat').innerText = seat;
    $('status').innerText = 'Joined';
    $('btnReady').disabled = false;
    $('roomPanel').style.display = 'block';
    // Try to update room state / hand
    updateRoomState();
    startPolling();
  }

  async function updateRoomState() {
    if (!roomId) return;
    const resp = await api('/api/room/' + encodeURIComponent(roomId));
    if (!resp.ok) {
      logEvent({ error: 'get room failed', status: resp.status });
      return;
    }
    const st = resp.json.state || {};
    $('roomState').innerText = st.game_state || 'unknown';
    // If server has hands and you are included, server's reconnect endpoint exposes hand; request reconnect
    if (sessionId) {
      const r = await api('/api/reconnect', 'POST', { session_id: sessionId });
      if (r.ok) {
        renderHand(r.json.hand || r.json.room_state?.game?.hand_counts ? [] : (r.json.hand || []));
        // If reconnect returned hand explicitly, use it
        if (r.json.hand) {
          renderHand(r.json.hand);
        } else if (r.json.room_state && r.json.room_state.game) {
          // show counts only if no hand exposed
          renderHandCounts(r.json.room_state.game.hand_counts || {});
        }
      }
    }
  }

  function renderHand(cards) {
    const container = $('hand');
    container.innerHTML = '';
    if (!cards || cards.length === 0) {
      container.innerHTML = '<div class="small">No cards yet</div>';
      return;
    }
    for (const c of cards) {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerText = c;
      el.onclick = () => playCard(c);
      container.appendChild(el);
    }
  }

  function renderHandCounts(counts) {
    const container = $('hand');
    container.innerHTML = '';
    for (const s of [0,1,2,3]) {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerText = `Seat ${s}: ${counts[s] || 0} cards`;
      container.appendChild(el);
    }
  }

  async function sendReady() {
    if (!sessionId) return alert('Join first');
    const res = await api('/api/ready', 'POST', { session_id: sessionId });
    if (!res.ok) {
      logEvent({ error: 'ready failed', status: res.status, body: res.json });
      return;
    }
    logEvent({ msg: 'Ready sent', all_ready: res.json.all_ready });
  }

  async function playCard(card) {
    if (!sessionId) return alert('Join first');
    const confirmed = confirm('Play ' + card + '?');
    if (!confirmed) return;
    const res = await api('/api/play_card', 'POST', { session_id: sessionId, card });
    if (!res.ok) {
      logEvent({ error: 'play failed', status: res.status, body: res.json });
      alert('Play failed: ' + JSON.stringify(res.json));
      return;
    }
    // update local UI: remove card if present
    const handDiv = $('hand');
    const cardEls = handDiv.querySelectorAll('.card');
    for (const el of cardEls) {
      if (el.innerText === card) { el.remove(); break; }
    }
    logEvent({ msg: 'Card played', card });
  }

  // DOM hooks
  $('btnJoin').onclick = joinRoom;
  $('btnReady').onclick = sendReady;
  $('btnGetState').onclick = updateRoomState;

})();
</script>
</body>
</html>
